<%
valid_nodes = @intrusion_nodes.select do |node|
  node.dig('rbname') &&
  node.dig('redborder', 'ti_policy_id') &&
  node.dig('redborder', 'ti_policy_name') && 
  node.dig('redborder', 'ti_policy_threshold_ip') && 
  node.dig('redborder', 'ti_policy_threshold_sha1') && 
  node.dig('redborder', 'ti_policy_threshold_sha2') && 
  node.dig('redborder', 'ti_policy_threshold_url') && 
  node.dig('redborder', 'ti_policy_threshold_domain')
end

if valid_nodes && valid_nodes.any? %>
filter {
  threat_intelligence {
    memcached_servers => <%= @memcached_servers %>

    sensors_policies => {
<% valid_nodes.each_with_index do |node, i| %>
      "<%= node['rbname'] %>" => '<%= { 'id' => node['redborder']['ti_policy_id'], 'name' => node['redborder']['ti_policy_name'], 'threshold_ip' => node['redborder']['ti_policy_threshold_ip'] }.to_json, 'threshold_ip' => node['redborder']['ti_policy_threshold_sha1'] }.to_json, 'threshold_sha2' => node['redborder']['ti_policy_threshold_sha2'] }.to_json, 'threshold_url' => node['redborder']['ti_policy_threshold_url'] }.to_json, 'threshold_domain' => node['redborder']['ti_policy_threshold_domain'] }.to_json %>'
<% end %>
    }

    indicators_mapping => {
      "src" => "ip"
      "dst" => "ip"
      "public_ip" => "ip"
      "sha256" => "sha2"
      "file_uri" => "url"
      "file_hostname" => "domain"
    }
  }
}
<% else %>
# No threat intelligence policies found.
<% end %>