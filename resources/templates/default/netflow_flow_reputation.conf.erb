<% valid_nodes = @flow_nodes.select do |node|
     node.dig('rbname') &&
     node.dig('redborder', 'flow_reputation_id') &&
     node.dig('redborder', 'flow_reputation_name')
   end %>
filter {
  flow_reputation {
    memcached_servers => <%= @memcached_servers %>
    sensor_policy_map => {
<% valid_nodes.each_with_index do |node, i| %>
      "<%= node['rbname'] %>" => '<%= { 'id' => node['redborder']['flow_reputation_id'], 'name' => node['redborder']['flow_reputation_name'] }.to_json %>'
<% end %>
    }
  }
}
