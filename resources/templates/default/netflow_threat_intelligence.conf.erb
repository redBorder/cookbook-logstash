<% valid_nodes = @flow_nodes.select do |node|
     node.dig('rbname') && node.dig('redborder', 'flow_reputation_id')
   end %>
filter {
  ti_reputation {
    memcached_servers => <%= @memcached_servers %>
    key_mapping => {
      "lan_ip"    => "lan_ip_is_malicious"
      "wan_ip"    => "wan_ip_is_malicious"
      "public_ip" => "public_ip_is_malicious"
    }
    sensor_field => "sensor_name"
    sensor_policy_map => {
<% valid_nodes.each_with_index do |node, i| %>
      "<%= node['rbname'] %>" => "<%= node['redborder']['flow_reputation_id'] %>"<%= "," unless i == valid_nodes.length - 1 %>
<% end %>
    }
  }
}
