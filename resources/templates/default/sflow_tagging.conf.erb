filter {
  
  # Default direction
  mutate {
    add_field => {
      "direction" => "upstream"
    }
  }

  if ![tag] or [tag] == 0 {
    <% @flow_nodes.select{|s| s[:ipaddress] and s["redborder"] and s["redborder"]["homenets"] and !s["redborder"]["blocked"]}.each do |flow_node| %>
    if [peer_ip_src] == "<%=flow_node[:ipaddress]%>" {
      # Determine if direction is different than "upstream"
      ruby { 
        code => " require 'ipaddr'
                  
                  homenets = [<%=flow_node["redborder"]["homenets"].map{|h| "IPAddr.new('#{h["value"]}')"} .join(",")%>]

                  if homenets.any? {|subnet| subnet.include?(event.get('ip_src')) } 
                    if homenets.any? {|subnet| subnet.include?(event.get('ip_dst')) }
                      event.set('direction', 'internal')
                    else                   
                      event.set('direction', 'downstream') 
                    end
                  end
                 "
      }
    }
  <% end %>
  } else if [tag] == 1 {
      mutate { add_field => { "direction" => "downstream" } }
  } else if [tag] == 3 {
      mutate { add_field => { "direction" => "internal" } }
  }
}